{% extends "base.html" %}

{% block title %}Face Recognition - Face Recognition Attendance{% endblock %}

{% block extra_css %}
<style>
    .camera-container {
        position: relative;
        max-width: 640px;
        margin: 0 auto;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }

    #video {
        width: 100%;
        height: auto;
        display: block;
    }

    .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        pointer-events: none;
    }

    .recognition-status {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        padding: 1rem;
        border-radius: 15px;
        color: white;
        text-align: center;
        font-weight: 600;
    }

    .controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .recognition-log {
        max-height: 300px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 1rem;
        margin-top: 2rem;
    }

    .log-entry {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        border-left: 4px solid #2ecc71;
    }

    .log-entry.error {
        border-left-color: #e74c3c;
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div style="padding: 2rem 0;">
    <div style="text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            <i class="fas fa-camera"></i> Face Recognition
        </h1>
        <p style="color: rgba(255, 255, 255, 0.7);">Position your face in front of the camera for attendance</p>
    </div>

    <div class="card">
        <div class="camera-container">
            <video id="video" autoplay muted playsinline></video>
            <div class="camera-overlay"></div>
            <div class="recognition-status" id="status">
                <i class="fas fa-camera"></i> Initializing camera...
            </div>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn btn-primary" onclick="startCamera()">
                <i class="fas fa-play"></i> Start Camera
            </button>
            <button id="captureBtn" class="btn btn-secondary" onclick="captureImage()" disabled>
                <i class="fas fa-camera-retro"></i> Capture & Recognize
            </button>
            <button id="stopBtn" class="btn btn-danger" onclick="stopCamera()" disabled>
                <i class="fas fa-stop"></i> Stop Camera
            </button>
        </div>

        <div style="text-align: center; margin-top: 1rem;">
            <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: rgba(255, 255, 255, 0.8);">
                <input type="checkbox" id="autoCapture" style="margin: 0;">
                Auto-capture every 3 seconds
            </label>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 1rem; color: #667eea;">
            <i class="fas fa-list"></i> Recognition Log
        </h3>
        <div class="recognition-log" id="logContainer">
            <p style="color: rgba(255, 255, 255, 0.6); text-align: center; font-style: italic;">
                Recognition results will appear here...
            </p>
        </div>
        <div style="text-align: center; margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="clearLog()">
                <i class="fas fa-trash"></i> Clear Log
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let video = document.getElementById('video');
    let canvas = document.createElement('canvas');
    let context = canvas.getContext('2d');
    let stream = null;
    let autoCapture = false;
    let autoCaptureInterval = null;

    async function startCamera() {
        try {
            updateStatus('<i class="fas fa-spinner fa-spin"></i> Starting camera...', 'info');
            
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 },
                    facingMode: 'user'
                } 
            });
            
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                updateStatus('<i class="fas fa-check-circle"></i> Camera ready - Position your face in the frame', 'success');
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
            };
            
        } catch (error) {
            console.error('Error accessing camera:', error);
            updateStatus('<i class="fas fa-exclamation-triangle"></i> Camera access denied or not available', 'error');
        }
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            stream = null;
        }
        
        if (autoCaptureInterval) {
            clearInterval(autoCaptureInterval);
            autoCaptureInterval = null;
        }
        
        updateStatus('<i class="fas fa-camera-slash"></i> Camera stopped', 'info');
        
        document.getElementById('startBtn').disabled = false;
        document.getElementById('captureBtn').disabled = true;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('autoCapture').checked = false;
    }

    function captureImage() {
        if (!stream) {
            updateStatus('<i class="fas fa-exclamation-triangle"></i> Camera not started', 'error');
            return;
        }

        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        
        updateStatus('<i class="fas fa-spinner fa-spin"></i> Processing face recognition...', 'info');
        
        fetch('/api/recognize_face', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ image: imageData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.recognized_students && data.recognized_students.length > 0) {
                const student = data.recognized_students[0].student;
                updateStatus(`<i class="fas fa-check-circle"></i> Recognized: ${student.name} (${student.student_id})`, 'success');
                addLogEntry(`✅ ${student.name} (ID: ${student.student_id}) - Attendance marked`, 'success');
            } else if (data.message === 'No face detected') {
                updateStatus('<i class="fas fa-user-slash"></i> No face detected in image', 'warning');
                addLogEntry('⚠️ No face detected - Please position your face clearly in the frame', 'warning');
            } else {
                updateStatus('<i class="fas fa-user-times"></i> Face detected but not recognized', 'warning');
                addLogEntry('❌ Unknown face detected - Student not in database', 'error');
            }
        })
        .catch(error => {
            console.error('Recognition error:', error);
            updateStatus('<i class="fas fa-exclamation-triangle"></i> Recognition failed', 'error');
            addLogEntry('❌ Recognition failed - Please try again', 'error');
        });
    }

    function updateStatus(message, type) {
        const statusElement = document.getElementById('status');
        statusElement.innerHTML = message;
        
        // Remove existing classes
        statusElement.classList.remove('pulse');
        
        // Add pulse animation for certain types
        if (type === 'success' || type === 'error') {
            statusElement.classList.add('pulse');
        }
    }

    function addLogEntry(message, type) {
        const logContainer = document.getElementById('logContainer');
        const timestamp = new Date().toLocaleTimeString();
        
        // Clear the placeholder message if it exists
        if (logContainer.children.length === 1 && logContainer.children[0].tagName === 'P') {
            logContainer.innerHTML = '';
        }
        
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type === 'error' || type === 'warning' ? 'error' : ''}`;
        logEntry.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${message}</span>
                <small style="color: rgba(255, 255, 255, 0.6);">${timestamp}</small>
            </div>
        `;
        
        logContainer.insertBefore(logEntry, logContainer.firstChild);
        
        // Keep only last 10 entries
        while (logContainer.children.length > 10) {
            logContainer.removeChild(logContainer.lastChild);
        }
    }

    function clearLog() {
        const logContainer = document.getElementById('logContainer');
        logContainer.innerHTML = '<p style="color: rgba(255, 255, 255, 0.6); text-align: center; font-style: italic;">Recognition results will appear here...</p>';
    }

    // Auto-capture functionality
    document.getElementById('autoCapture').addEventListener('change', function() {
        autoCapture = this.checked;
        
        if (autoCapture && stream) {
            autoCaptureInterval = setInterval(() => {
                if (stream && !document.getElementById('captureBtn').disabled) {
                    captureImage();
                }
            }, 3000);
            addLogEntry('🔄 Auto-capture enabled (every 3 seconds)', 'info');
        } else {
            if (autoCaptureInterval) {
                clearInterval(autoCaptureInterval);
                autoCaptureInterval = null;
            }
            if (!autoCapture) {
                addLogEntry('⏹️ Auto-capture disabled', 'info');
            }
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        stopCamera();
    });
</script>
{% endblock %}
